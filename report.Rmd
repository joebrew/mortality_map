---
title: "Mortality maps"
author: "Joe Brew, Faustino Vilanculo, Charfudin Sacoor"
date: '`r Sys.Date()`'
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
subtitle: AFEPI
bibliography: skeleton.bib
---

```{r setup, include=FALSE}
packages <- c('tufte',
              'cism',
              'tidyverse',
              'rgdal',
              'sp',
              'maptools',
              'readxl',
              'tidyr',
              'knitr',
              'base', 
              'rmarkdown',
              'broom',
              'leaflet',
              'RColorBrewer')
packages <- sort(packages)
for (i in 1:length(packages)){
  eval(parse(text = 
               paste0('library(',
                      packages[i],
                      ')')))
}


knitr::opts_chunk$set(tidy = FALSE, 
                      cache.extra = packageVersion('tufte'),
                      comment = NA, 
                      echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      error = TRUE, 
                      cache = FALSE,
                      fig.path = "plots/")
options(htmltools.dir.version = FALSE)

# Source data preparation
source('prepare_data.R')
```


# Introduction

This document contains geographic visualizations and tables pertaining to the AFEPI study, as well as the demographic data collected and managed by the Centro de Investigação em Saude de Manhiça. The data required to produce the outputs in this document are available upon request to authorized collaborators.^[To request data, email joebrew@gmail.com] The code for this report is freely available online.^[https://github.com/joebrew/mortality_map]

## Methods

We combined AFEPI study data,^[emailed by Denise Naniche on February 6, 2017] with CISM demographic location data,^[emailed Aura Hunguana on February 1, 2017] with CISM spatial files^[provided by Faustino Vilanculo], with demographic mortality data.^[emailed by Charfudin Sacoor on February 3, 2017] After some fairly straightforward cleaning and merging,^[https://github.com/joebrew/mortality_map/blob/master/prepare_data.R] we produced visualizations using open-source spatial and statistical packages in the R language[@R-tufte]. 

# Results

## Population

### Both sexes

The below table shows the population and number of deaths (30-50 year olds only) for each zone.

```{r}
make_pretty(pop %>% mutate(year = as.character(year)) %>% 
              dplyr::select(zone_number,
                            year, 
                            pop))
```

### By sex

```{r}
make_pretty(pop_sex %>%
              mutate(year = as.character(year)) %>%
              dplyr::select(zone_number,
                            year,
                            gender,
                            pop))

```

## Deaths and death rate

The below shows a true death rate and age standardized death rate.

```{r}
make_pretty(pop %>%
              mutate(year = as.character(year)),
            round_digits = 4)
```

The below plot shows the correlation between the real death rate and the age-standardized death rate, in which size is a function of a zone's population.

```{r}
ggplot(data = pop,
       aes(x = death_rate,
           y = adjusted_death_rate,
           size = pop)) +
  geom_point(alpha = 0.3) +
  theme_mortality() +
  xlab('Death rate') +
  ylab('Age-standardized death rate') +
  ggtitle('Death rate vs. age-standardized death rate',
          'One observation = one zone-year, 2010-2016')


```

## Mortality of 30-50 year olds

### 2010

#### Both sexes

```{r}
x <- join_data(year = 2010,
                 age_group = '30-50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, ages 30-50')

```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```



#### Males

```{r}
x <- join_data_sex(year = 2010,
                 age_group = '30-50',
                 sex = 'M')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, males, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Females

```{r}
x <- join_data_sex(year = 2010,
                 age_group = '30-50',
                 sex = 'F')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, females, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```



### 2012

#### Both sexes

```{r}
x <- join_data(year = 2012,
                 age_group = '30-50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2012, ages 30-50')

```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```



#### Males

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'M')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2012, males, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Females

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'F')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2012, females, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```


### 2014

#### Both sexes

```{r}
x <- join_data(year = 2014,
                 age_group = '30-50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2014, ages 30-50')

```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```



#### Males

```{r}
x <- join_data_sex(year = 2014,
                 age_group = '30-50',
                 sex = 'M')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2014, males, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Females

```{r}
x <- join_data_sex(year = 2014,
                 age_group = '30-50',
                 sex = 'F')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2014, females, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```



## HIV rate among 30-50 year olds

In the below maps, HIV rate refers to the percentage of positives among all tested. It _only includes the AFEPI study_.

### 2010

#### Both sexes

```{r}
x <- join_data_hiv(year = 2010,
                 condition = 'Age >= 18 & Age <=50')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2010, both sexes, ages 30-50')

```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Males

```{r}
x <- join_data_hiv(year = 2010,
                 condition = 'Age >= 18 & Age <=50 & Sex == "Male"')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2010, males, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Females

```{r}
x <- join_data_hiv(year = 2010,
                 condition = 'Age >= 18 & Age <=50 & Sex == "Female"')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2010, females, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```




### 2012

#### Both sexes

```{r}
x <- join_data_hiv(year = 2012,
                 condition = 'Age >= 18 & Age <=50')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2012, both sexes, ages 30-50')

```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Males

```{r}
x <- join_data_hiv(year = 2012,
                 condition = 'Age >= 18 & Age <=50 & Sex == "Male"')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2012, males, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

#### Females

```{r}
x <- join_data_hiv(year = 2012,
                 condition = 'Age >= 18 & Age <=50 & Sex == "Female"')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2012, females, ages 30-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```





# Overlays

## Both sexes

The below map shows the 2012 mortality rate at the zone level, with an overlay of all AFEPI participants (for whom geographic data were available), colored by test result.

```{r}
x <- join_data(year = 2012,
                 age_group = '30-50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2012, ages 30-50') +
  geom_point(data = afepi %>%
               filter(Resulttest != 'Indeterminado'),
             aes(x = lng,
                 y = lat,
                 group = NA,
                 color = Resulttest),
             alpha = 0.5,
             size = 0.5) +
  scale_color_manual(name = '',
                     values = c('darkgreen', 'darkred'))


```

The below map is identical, but interactive.

```{r}
x <- join_data(year = 2012,
                 age_group = '30-50')
z <- afepi %>%
               filter(Resulttest != 'Indeterminado') %>%
                 mutate(color = ifelse(Resulttest == 'Positivo', 'darkgreen', 'darkred'))
popup <- paste0("<strong>Study ID: </strong>", 
                  z$StudyID, 
                  "<br><strong>",
                  'Age',
                  ": </strong>", 
                  z$Age,
                  "<br><strong>",
                  'Test result',
                  ": </strong>",
                  z$Resulttest)
plot_joined_data_leaflet(x) %>%
  addCircleMarkers(data = z,
               lng = ~lng,
               lat = ~lat,
               fillColor = ~color,
               color = NA,
               opacity = 0,
               radius = 3,
               popup = popup)
```



## Males

The below map shows the 2012 mortality rate at the zone level, with an overlay of all male AFEPI participants (for whom geographic data were available), colored by test result.

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'M')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, males, ages 30-50') +
  geom_point(data = afepi %>%
               filter(Resulttest != 'Indeterminado',
                      Sex == 'Male'),
             aes(x = lng,
                 y = lat,
                 group = NA,
                 color = Resulttest),
             alpha = 0.5,
             size = 0.5) +
  scale_color_manual(name = '',
                     values = c('darkgreen', 'darkred'))


```

The below map is identical, but interactive.

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'M')
z <- afepi %>%
               filter(Resulttest != 'Indeterminado',
                      Sex == 'Male') %>%
                 mutate(color = ifelse(Resulttest == 'Positivo', 'darkgreen', 'darkred'))
popup <- paste0("<strong>Study ID: </strong>", 
                  z$StudyID, 
                  "<br><strong>",
                  'Age',
                  ": </strong>", 
                  z$Age,
                  "<br><strong>",
                  'Test result',
                  ": </strong>",
                  z$Resulttest)
plot_joined_data_leaflet(x) %>%
  addCircleMarkers(data = z,
               lng = ~lng,
               lat = ~lat,
               fillColor = ~color,
               color = NA,
               opacity = 0,
               radius = 3,
               popup = popup)
```




## Females

The below map shows the 2012 mortality rate at the zone level, with an overlay of all female AFEPI participants (for whom geographic data were available), colored by test result.

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'F')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, females, ages 30-50') +
  geom_point(data = afepi %>%
               filter(Resulttest != 'Indeterminado',
                      Sex == 'Female'),
             aes(x = lng,
                 y = lat,
                 group = NA,
                 color = Resulttest),
             alpha = 0.5,
             size = 0.5) +
  scale_color_manual(name = '',
                     values = c('darkgreen', 'darkred'))


```

The below map is identical, but interactive.

```{r}
x <- join_data_sex(year = 2012,
                 age_group = '30-50',
                 sex = 'F')
z <- afepi %>%
               filter(Resulttest != 'Indeterminado',
                      Sex == 'Female') %>%
                 mutate(color = ifelse(Resulttest == 'Positivo', 'darkgreen', 'darkred'))
popup <- paste0("<strong>Study ID: </strong>", 
                  z$StudyID, 
                  "<br><strong>",
                  'Age',
                  ": </strong>", 
                  z$Age,
                  "<br><strong>",
                  'Test result',
                  ": </strong>",
                  z$Resulttest)
plot_joined_data_leaflet(x) %>%
  addCircleMarkers(data = z,
               lng = ~lng,
               lat = ~lat,
               fillColor = ~color,
               color = NA,
               opacity = 0,
               radius = 3,
               popup = popup)
```


## Age distribution

### AFEPI participants

```{r}
cism_plot(x = afepi$Age) +
  labs(x = 'Years',
       title = 'Age distribution of AFEPI partipants')


```

### AFEPI participants by sex

```{r}
ggplot(data = afepi,
       aes(x = Age,
           group = Sex,
           fill = Sex,
           color = Sex)) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(name = 'Sex',
                    values = c('darkorange', 'darkgreen')) +
  theme_mortality() +
  labs(x = 'Years',
       title = 'Age distribution of AFEPI participants',
       subtitle = 'By sex')
```

### AFEPI participants by outcome

```{r}
ggplot(data = afepi %>%
         filter(Resulttest != 'Indeterminado'),
       aes(x = Age,
           group = Resulttest,
           fill = Resulttest)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(name = 'Test result',
                    values = c('darkorange', 'darkgreen')) +
  theme_mortality() +
  labs(title = 'Age distribution of AFEPI participants',
       subtitle = 'By result status')


```

### AFEPI participants by outcome and sex

```{r}
ggplot(data = afepi %>%
         filter(Resulttest != 'Indeterminado'),
       aes(x = Age,
           group = Resulttest,
           fill = Resulttest)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(name = 'Test result',
                    values = c('darkorange', 'darkgreen')) +
  theme_mortality() +
  labs(title = 'Age distribution of AFEPI participants',
       subtitle = 'By result status') +
  facet_wrap(~Sex)
```


### Residents of study area

(Used 2014)

```{r}
ggplot(data = member_expanded %>%
         filter(year == 2014,
                age >= 18,
                age <= 50),
       aes(x = age)) +
  geom_density(alpha = 0.6,
               fill = 'darkorange') +
  labs(x = 'Age',
       y = 'Density',
       title = 'Age distribution of Manhiça residents',
       subtitle = 'Per the census, filtering to only study aged population') +
  theme_mortality()
```

## Sex distribution

### AFEPI participants

```{r}
cism_plot(afepi$Sex) +
  labs(title = 'Sex distribution of AFEPI participants')


```

### Residents of study area


```{r}
x <- member_expanded %>%
         filter(year == 2014,
                age >= 18,
                age <= 50) %>%
  .$gender
  
x <- x[x %in% c('M', 'F')]
cism_plot(x) +
  labs(title = 'Sex distribution of study area',
       subtitle = 'Age group limited to 30-50, year 2014')


```

# Follow-up work

## Hotspot with zone data

The below maps use the Kulldorf spatial scan statistic method, aggregated at the zone level. The red area are the zone / those zones which are estimated to be the most likely cluster.

### Death rate map, 2010

```{r}
x <- join_data(year = 2010,
               age_group = '30-50')
hotspot(x,
  cases = x@data$n_deaths,
  population = x@data$pop)


```

### Death rate map, 2012

```{r}
x <- join_data(year = 2012,
               age_group = '30-50')
hotspot(x,
  cases = x@data$n_deaths,
  population = x@data$pop)


```


### HIV map 2010

```{r}
x <- join_data_hiv(year = 2010,
               condition = "Age >= 18 & Age <= 50")
hotspot(x,
  cases = x@data$positives,
  population = x@data$denom)
title('Most likely cluster (year: 2010, age group: 30-50)')


```

### HIV map 2012

```{r}
x <- join_data_hiv(year = 2012,
               condition = "Age >= 18 & Age <= 50")
hotspot(x,
  cases = x@data$positives,
  population = x@data$denom)
title('Most likely cluster (year: 2012, age group: 30-50)')

```

## Hotspots with point data

As am alternative to the Kulldorff spatial cluster detection method (the statistical framework behind SatScan), we can instead ignore administrative zones and use only point data. For this, we'll construct a smoothed surface^[raster] with a weighted HIV prevalence scores, as well as radial prevalences.


```{r}
# Make an hiv score for afepi
afepi_sp@data$hiv <- ifelse(afepi_sp@data$Resulttest == 'Positivo', 1, 0)

# Create a gridded dataframe with values 
# for the entire range (bbox) of afepi_sp
df_grid <- expand.grid(lng = seq(bbox(afepi_sp)[1,1],
                                 bbox(afepi_sp)[1,2],
                                 by = 0.001),
                       lat = seq(bbox(afepi_sp)[2,1],
                                 bbox(afepi_sp)[2,2],
                                 by = 0.001),
                       hiv = NA,
                       hiv_score = NA,
                       within_10 = NA,
                       within_05 = NA,
                       within_01 = NA,
                       color = NA,
                       x = NA,
                       x_score = NA)
df_grid$latitude <- df_grid$lat
df_grid$longitude <- df_grid$lng
coordinates(df_grid) <- ~longitude+latitude
df_grid_mortality <- df_grid

# Define a weighter
weighter <- 0.2

# Define a dataframe for plotting weight
weighter_df <- data.frame(x = 1:100,
                          y = (1 / 1:100) ^weighter)

```


For the below visualizations, we created a estimated "HIV prevalence score", which is the nearby HIV prevalence weighted by distance to the point in question. Our weight structure looks like this.

```{r}
ggplot(data = weighter_df,
       aes(x = x, y = y)) +
  geom_area(alpha = 0.3) +
  labs(x = 'Kilometers',
       y = 'Weight',
       title = 'Weight structure',
       subtitle = 'Kind of arbitrary, completely made up by Joe') +
  theme_mortality()
```

Using this method produces the below map, which can be understood as an indication of likely "hot" and "cold" areas for HIV

```{r}
# Go through each row of df_grid, getting the 
# weighted mean hiv score for that point
# and putting a color into df_grid
if('df_grid.RData' %in% dir()){
  load('df_grid.RData')
} else {
  the_rows <- nrow(df_grid)
  for (i in 1:nrow(df_grid)){
    message(paste0(i, ' of ', the_rows))
  # Get distance from every point in afepi
  distances <- spDistsN1(pts = afepi_sp,
                        pt = df_grid[i,],
                        longlat = TRUE)
  # Define which are acceptably close
  close_enough <- which(distances <= 100)
  # Get an hiv score
  hiv <- stats::weighted.mean(x = afepi_sp$hiv[close_enough],
                       w = (1 / distances[close_enough]) ^weighter,
                       na.rm = TRUE)
  # Assign hiv to the dataframe
  df_grid$hiv[i] <- hiv
  # Get the hiv score on a 0-1000 scale
  # and add 1 so that it's on a 1-1001 scale (for coloring)
  hiv_score <- round(hiv * 1000) + 1
  df_grid$hiv_score[i] <- hiv_score
  
  # Get likely number of hiv positives within 10 km
  within_10 <- (mean(afepi_sp$hiv[distances <= 10], na.rm = TRUE)/100) *
    length(which(distances <= 10))
  df_grid$within_10[i] <- ifelse(is.na(within_10),
                                 0,
                                 within_10)
  
    # Get likely number of hiv positives within 5 km
  within_05 <- (mean(afepi_sp$hiv[distances <= 05], na.rm = TRUE)/100) *
    length(which(distances <= 05))
  df_grid$within_05[i] <- ifelse(is.na(within_05),
                                 0,
                                 within_05)
  
      # Get likely number of hiv positives within 1 km
  within_01 <- (mean(afepi_sp$hiv[distances <= 01], na.rm = TRUE)/100) *
    length(which(distances <= 01))
  df_grid$within_01[i] <- ifelse(is.na(within_01),
                                 0,
                                 within_01)
    
}
save('df_grid', file = 'df_grid.RData')

}

# Fix up the hiv score
df_grid$hiv_score <-
  df_grid$hiv_score -
  min(df_grid$hiv_score, na.rm = TRUE)

# Create a n length color vector
color_vector <-
  colorRampPalette(c('red', 'yellow', 'green'))(max(df_grid$hiv_score, na.rm = TRUE) +1)

# If there are no nearby obs, just make white
# otherwise, give it a color from the palette
df_grid$color <- 
  ifelse(is.na(df_grid$hiv_score),
         'white',
         color_vector[df_grid$hiv_score])

library(raster)
library(rasterVis)
# Convert df_grid to raster
temp <- df_grid@data %>% arrange(lng, lat)
r <- rasterFromXYZ(temp[, c('lng', 'lat', 'hiv')])
# Make only for district
proj4string(afepi_sp) <- proj4string(man)
proj4string(df_grid) <- proj4string(afepi_sp)
# Get border of afepi_sp
the_border <- rgeos::gConvexHull(afepi_sp)
x <- over(df_grid, polygons(the_border))
df_grid_small <- df_grid[!is.na(x),]
temp <- df_grid_small@data %>% arrange(lng, lat)
r <- rasterFromXYZ(temp[, c('lng', 'lat', 'hiv')], crs = proj4string(man))
plot(r, col = colorRampPalette(rev(brewer.pal(n = 9, 'Spectral')))(1000))

# contour(r, add = TRUE,
#         col = adjustcolor('black', alpha.f = 0.3))
plot(man, add = TRUE,
     fill = NA,
     color = adjustcolor('grey', alpha.f = 0.2))
title(main = 'Estimated HIV prevalence')
```

Here is a "zoom-out" of the same map

```{r}
plot(man)
plot(r, 
     col = colorRampPalette(rev(brewer.pal(n = 9, 'Spectral')))(1000),
     add = TRUE)


contour(r, add = TRUE,
        col = adjustcolor('black', alpha.f = 0.3))
plot(man, add = TRUE,
     fill = NA,
     color = adjustcolor('grey', alpha.f = 0.2))
title(main = 'Estimated HIV prevalence')
```

We can do the same for mortality (2010-2012), only in our study period (2010-2012).

```{r}

# Get mortality from 2010-2012
mort <- member_expanded %>%
  filter(year <= 2012,
         year >= 2010,
         age >= 30,
         age <= 50) %>%
  mutate(died = ifelse(died_this_year, 1, 0)) %>%
  mutate(Family_id = substr(perm_id, 1, 8)) %>%
  left_join(coordenadas@data) %>%
  filter(!is.na(lng),
         !is.na(lat))
mort_sp <- mort
coordinates(mort_sp) <- ~lng + lat

# Go through each row of df_grid, getting the 
# weighted mean hiv score for that point
# and putting a color into df_grid
if('df_grid_mortality.RData' %in% dir()){
  load('df_grid_mortality.RData')
} else {
  the_rows <- nrow(df_grid_mortality)
  for (i in 1:nrow(df_grid_mortality)){
    message(paste0(i, ' of ', the_rows))
  # Get distance from every point in afepi
  distances <- spDistsN1(pts = mort_sp,
                        pt = df_grid_mortality[i,],
                        longlat = TRUE)
  # Define which are acceptably close
  close_enough <- which(distances <= 100)
  # Get an hiv score
  x <- stats::weighted.mean(x = mort_sp$died[close_enough],
                       w = (1 / distances[close_enough]) ^weighter,
                       na.rm = TRUE)
  # Assign hiv to the dataframe
  df_grid_mortality$x[i] <- x
  # Get the hiv score on a 0-1000 scale
  # and add 1 so that it's on a 1-1001 scale (for coloring)
  x_score <- round(x * 1000) + 1
  df_grid_mortality$x_score[i] <- x_score
  
  # Get likely number of x positives within 10 km
  within_10 <- (mean(mort_sp$x[distances <= 10], na.rm = TRUE)/100) *
    length(which(distances <= 10))
  df_grid_mortality$within_10[i] <- ifelse(is.na(within_10),
                                 0,
                                 within_10)
  
    # Get likely number of x positives within 5 km
  within_05 <- (mean(mort_sp$x[distances <= 05], na.rm = TRUE)/100) *
    length(which(distances <= 05))
  df_grid_mortality$within_05[i] <- ifelse(is.na(within_05),
                                 0,
                                 within_05)
  
      # Get likely number of x positives within 1 km
  within_01 <- (mean(mort_sp$x[distances <= 01], na.rm = TRUE)/100) *
    length(which(distances <= 01))
  df_grid_mortality$within_01[i] <- ifelse(is.na(within_01),
                                 0,
                                 within_01)
    
}
save('df_grid_mortality', file = 'df_grid_mortality.RData')

}

# Fix up the x score
df_grid_mortality$x_score <-
  df_grid_mortality$x_score -
  min(df_grid_mortality$x_score, na.rm = TRUE)

# Create a n length color vector
color_vector <-
  colorRampPalette(c('red', 'yellow', 'green'))(max(df_grid_mortality$x_score, na.rm = TRUE) +1)

# If there are no nearby obs, just make white
# otherwise, give it a color from the palette
df_grid_mortality$color <- 
  ifelse(is.na(df_grid_mortality$x_score),
         'white',
         color_vector[df_grid_mortality$x_score])

library(raster)
library(rasterVis)
# Convert df_grid_mortality to raster
temp <- df_grid_mortality@data %>% arrange(lng, lat)
r_mortality <- rasterFromXYZ(temp[, c('lng', 'lat', 'x')])
# Make only for district
proj4string(afepi_sp) <- proj4string(man)
proj4string(df_grid_mortality) <- proj4string(afepi_sp)
# Get border of afepi_sp
the_border <- rgeos::gConvexHull(afepi_sp)
x <- over(df_grid_mortality, polygons(the_border))
df_grid_mortality_small <- df_grid_mortality[!is.na(x),]
temp <- df_grid_mortality_small@data %>% arrange(lng, lat)
r_mortality <- rasterFromXYZ(temp[, c('lng', 'lat', 'x')], crs = proj4string(man))
plot(r_mortality, col = colorRampPalette(rev(brewer.pal(n = 9, 'Spectral')))(1000))
# contour(r_mortality, add = TRUE,
#         col = adjustcolor('black', alpha.f = 0.3))
plot(man, add = TRUE,
     fill = NA,
     color = adjustcolor('grey', alpha.f = 0.2))
title(main = 'Estimated mortality')

```


## Side-by-side map

```{r}
# pdf('side_by_side.pdf', height = 8, width =11)
par(mfrow = c(1,2))
plot(r, col = colorRampPalette(rev(brewer.pal(n = 9, 'Spectral')))(1000))
plot(man, add = TRUE,
     fill = NA,
     color = adjustcolor('grey', alpha.f = 0.2))
title('Estimated HIV prevalence')
plot(r_mortality, col = colorRampPalette(rev(brewer.pal(n = 9, 'Spectral')))(1000))
plot(man, add = TRUE,
     fill = NA,
     color = adjustcolor('grey', alpha.f = 0.2))
title('Estimated mortality (30-50 y.o.)')
par(mfrow = c(1,1))
# dev.off()
```

```{r, eval = FALSE}
ggplot(man3_fortified,
       aes(x = long, y = lat)) +
  geom_polygon(aes(group = id), fill = 'black') +
  geom_raster(data = temp,
              aes(x = lng, y = lat, fill = hiv)) +
    geom_polygon(aes(group = id), fill = NA, color = 'black', alpha = 0.5) +
    xlab('Longitude') +
  ylab('Latitude') +
  ggtitle('Estimated HIV prevalence') +
  theme(panel.background = element_rect(fill = 'white', 
                                        colour = 'white'),
        panel.grid.major = element_line(colour = "white")) 
```


## Kriging map

### HIV

```{r}
# Krieging - HIV
sp_df <- afepi_sp
sp_points <- SpatialPoints(sp_df)

# Create a fine grid
pixels_per_side = 200
bottom.left = apply(sp_points@coords,2,min)
top.right = apply(sp_points@coords,2,max)
margin = abs((top.right-bottom.left))/10
bottom.left = bottom.left-margin
top.right = top.right+margin
pixel.size = abs(top.right-bottom.left)/pixels_per_side
g = GridTopology(cellcentre.offset=bottom.left,
             cellsize=pixel.size,
             cells.dim=c(pixels_per_side,pixels_per_side))


# make projected before krieging
new_pro <- CRS("+init=epsg:3036")
# proj4string(fit_points) <-
#   proj4string(the_border) <- 
#   proj4string(sp_df) <- new_pro


the_border <- rgeos::gConvexHull(afepi_sp)

grid_points = SpatialPoints(g)
proj4string(grid_points) <- proj4string(the_border)
in_points = !is.na(over(grid_points,polygons(the_border)))
fit_points = SpatialPoints(as.data.frame(grid_points)[in_points,])
proj4string(fit_points) <- proj4string(the_border)

fit_points <- spTransform(fit_points, new_pro)
the_border <- spTransform(the_border, new_pro)
sp_df <- spTransform(sp_df, new_pro)


# Do kriging
library(automap)
if('krig_hiv.RData' %in% dir()){
  load('krig_hiv.RData')
} else {
  krig <- autoKrige(hiv~1, sp_df, new_data=fit_points)
  save(krig, file = 'krig_hiv.RData')
}
interp_data = as.data.frame(krig$krige_output)
colnames(interp_data) = c("longitude","latitude","APPT_pred","APPT_var","APPT_stdev")

# Convert bag to lat long
interp_data_sp <- interp_data
coordinates(interp_data_sp) <- ~longitude+latitude
proj4string(interp_data_sp) <- new_pro
interp_data_sp <- spTransform(interp_data_sp, proj4string(man))
interp_data$longitude <- interp_data$latitude <- NULL
interp_data$longitude <- coordinates(interp_data_sp)[,1]
interp_data$latitude <- coordinates(interp_data_sp)[,2]

# Set up map plot
map_base_aesthetics = aes(x=longitude, y=latitude, group=group)
map_base = geom_polygon(data=the_border, map_base_aesthetics)
borders = geom_polygon(data=the_border, map_base_aesthetics, color="black", fill=NA)

nbin=20

ggplot(data=interp_data %>%
         filter(APPT_pred <= quantile(APPT_pred, 0.98),
                APPT_pred >= quantile(APPT_pred, 0.02)), 
       aes(x=longitude, y=latitude)) + 
    geom_polygon(data = man3_fortified, aes(x = long,
           y = lat,
           # z = p_positive,
           group = group),
           fill = 'white',
           color = 'black') +
  geom_point(aes(color = APPT_pred),
             alpha = 0.5,
             size = 0.1) +

  # coord_map() +
  # geom_tile(aes(fill=APPT_pred)) +
  # stat_contour(aes(z=APPT_pred), bins=nbin, color="#999999") +
  scale_color_gradient2(name = 'Interpolated\npositivity',
                       low="white",mid="orange",high="red") +
  # borders +
  theme_cism() +
  labs(title = 'Interpolated HIV positivity rate',
       subtitle = 'Krieging method',
       x = 'Longitude',
       y = 'Latitude')

```

### Mortality

```{r}
# Krieging - mortality
sp_df <- member_expanded %>%
  filter(year >= 2010,
         year <= 2012,
         age >= 30,
         age <= 50) %>%
  sample_n(5000)
  
sp_df$x <- as.numeric(sp_df$gps_longitude)
sp_df$y <- as.numeric(sp_df$gps_latitude)
sp_df <- sp_df %>%
  filter(!is.na(x),
         !is.na(y))
coordinates(sp_df) <- ~x+y
proj4string(sp_df) <- proj4string(man)
sp_points <- SpatialPoints(sp_df)

# Create a fine grid
pixels_per_side = 200
bottom.left = apply(sp_points@coords,2,min)
top.right = apply(sp_points@coords,2,max)
margin = abs((top.right-bottom.left))/10
bottom.left = bottom.left-margin
top.right = top.right+margin
pixel.size = abs(top.right-bottom.left)/pixels_per_side
g = GridTopology(cellcentre.offset=bottom.left,
             cellsize=pixel.size,
             cells.dim=c(pixels_per_side,pixels_per_side))


# make projected before krieging
new_pro <- CRS("+init=epsg:3036")
# proj4string(fit_points) <-
#   proj4string(the_border) <- 
#   proj4string(sp_df) <- new_pro


the_border <- rgeos::gConvexHull(afepi_sp)

grid_points = SpatialPoints(g)
proj4string(grid_points) <- proj4string(the_border)
in_points = !is.na(over(grid_points,polygons(the_border)))
fit_points = SpatialPoints(as.data.frame(grid_points)[in_points,])
proj4string(fit_points) <- proj4string(the_border)

fit_points <- spTransform(fit_points, new_pro)
the_border <- spTransform(the_border, new_pro)
sp_df <- spTransform(sp_df, new_pro)


# Do kriging
library(automap)
sp_df$died <- ifelse(is.na(sp_df$died_this_year),
                     0,
                     ifelse(sp_df$died_this_year,
                            1, 0))
if('krig_mortality.RData' %in% dir()){
  load('krig_mortality.RData')
} else {
  krig <- autoKrige(died~1, sp_df, new_data=fit_points)
  save(krig, file = 'krig_mortality.RData')
}

interp_data = as.data.frame(krig$krige_output)
colnames(interp_data) = c("longitude","latitude","APPT_pred","APPT_var","APPT_stdev")

# Convert bag to lat long
interp_data_sp <- interp_data
coordinates(interp_data_sp) <- ~longitude+latitude
proj4string(interp_data_sp) <- new_pro
interp_data_sp <- spTransform(interp_data_sp, proj4string(man))
interp_data$longitude <- interp_data$latitude <- NULL
interp_data$longitude <- coordinates(interp_data_sp)[,1]
interp_data$latitude <- coordinates(interp_data_sp)[,2]

# Set up map plot
map_base_aesthetics = aes(x=longitude, y=latitude, group=group)
map_base = geom_polygon(data=the_border, map_base_aesthetics)
borders = geom_polygon(data=the_border, map_base_aesthetics, color="black", fill=NA)

nbin=20

ggplot(data=interp_data %>%
         filter(APPT_pred <= quantile(APPT_pred, 0.98),
                APPT_pred >= quantile(APPT_pred, 0.02)), 
       aes(x=longitude, y=latitude)) + 
    geom_polygon(data = man3_fortified, aes(x = long,
           y = lat,
           # z = p_positive,
           group = group),
           fill = 'white',
           color = 'black') +
  geom_point(aes(color = APPT_pred),
             alpha = 0.5,
             size = 0.1) +

  # coord_map() +
  # geom_tile(aes(fill=APPT_pred)) +
  # stat_contour(aes(z=APPT_pred), bins=nbin, color="#999999") +
  scale_color_gradient2(name = 'Interpolated\nmortality',
                       low="white",mid="orange",high="red") +
  # borders +
  theme_cism() +
  labs(title = 'Interpolated adult mortality rate',
       subtitle = 'Krieging method',
       x = 'Longitude',
       y = 'Latitude')
```

```{r}
# Write some files
# r = hiv
# r_mortality = mortality
writeRaster(x = r,
            filename = 'rasters/hiv.tif',
            overwrite = TRUE)
writeRaster(x = r_mortality,
            filename = 'rasters/mortality.tif',
            overwrite = TRUE)

```

## HIV participation map 

I am not able to produce a map including location of people who did not want to participate in the study, as I do not have those data.

# Map that shows study area with zone number labels

(and an inset map showing Mozambique and Maputo province)

```{r, fig.height = 8, fig.width = 8, eval = FALSE}
library(cism)

par(fig = c(0,1,0,1))

plot(zonas,
     main = 'Study area')
text(as.matrix(coordinates(zonas)),
     labels = zonas@data$zone_number,
     col = adjustcolor('black', alpha.f = 0.5),
     cex = 0.5)
par(fig = c(0.01,0.35, 0.5, 1), new = T)  
plot(moz1, col = ifelse(moz1@data$NAME_1 == 'Maputo', 'red', 'white'), lwd = 0.2,
     main = 'Mozambique', cex.main = 0.4)
par(fig = c(0.18, 0.45, 0.5, 1), new = T)  
plot(moz1[moz1@data$NAME_1 == 'Maputo',], lwd = 0.2,
     main = 'Maputo province', cex.main = 0.4)
plot(zonas, add = TRUE, col = 'darkred', lwd =0.2)

```


## Map that shows the study area with all the geocoded deaths for 2012 

(Similar to Fig. 2 in  Gonzalez et al. 2015)

```{r}
x <- member_expanded %>%
         filter(year == 2012,
                died_this_year)

# Join to coordinates
x$Family_id <- substr(x$perm_id, 1, 8)
x <- left_join(x, coordenadas@data)


par(fig = c(0,1, 0, 1))
plot(zonas)
# points(afepi_sp)
points(x$lng,
       x$lat,
       col = adjustcolor('black', alpha.f = 0.3),
       cex = 0.3)


```



# Packages used

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(packages, file = 'skeleton.bib')
```

```{r}
citation_text <- c()
  for (i in 1:length(packages)){
    citation_text[i] <- 
    paste0('[@R-',
               packages[i],
               ']')
}
```

```{r, results='asis'}
for (i in 1:length(citation_text)){
    cat('\n\n***\n\n~~\n\n')
  cat(citation_text[i])
  cat('\n\n***\n\n<br><br>')
}

```