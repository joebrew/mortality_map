---
title: "Mortality maps"
subtitle: "AFEPI"
author: "Joe Brew and Faustino Vilanculo"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: skeleton.bib
link-citations: yes
---

```{r setup, include=FALSE}
packages <- c('tufte',
              'cism',
              'tidyverse',
              'rgdal',
              'sp',
              'maptools',
              'readxl',
              'tidyr',
              'knitr',
              'base', 
              'rmarkdown',
              'broom',
              'leaflet',
              'RColorBrewer')
packages <- sort(packages)
for (i in 1:length(packages)){
  eval(parse(text = 
               paste0('library(',
                      packages[i],
                      ')')))
}


knitr::opts_chunk$set(tidy = FALSE, 
                      cache.extra = packageVersion('tufte'),
                      comment = NA, 
                      echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      error = TRUE, 
                      cache = FALSE)
options(htmltools.dir.version = FALSE)

# Source data preparation
source('prepare_data.R')
```

# Introduction

This document contains geographic visualizations and tables pertaining to the AFEPI study, as well as the demographic data collected and managed by the Centro de Investigação em Saude de Manhiça. The data required to produce the outputs in this document are available upon request to authorized collaborators.^[To request data, email joebrew@gmail.com] The code for this report is freely available online.^[https://github.com/joebrew/mortality_map]

## Methods

We combined AFEPI study data,^[emailed by Denise Naniche on February 6, 2017] with CISM demographic location data,^[emailed Aura Hunguana on February 1, 2017] with CISM spatial files^[provided by Faustino Vilanculo], with demographic mortality data.^[emailed by Charfudin Sacoor on February 3, 2017] After some fairly straightforward cleaning and merging,^[https://github.com/joebrew/mortality_map/blob/master/prepare_data.R] we produced visualizations using open-source spatial and statistical packages in the R language[@R-tufte]. 

# Results

## Mortality of 18-50 year olds

### 2010

```{r}
x <- join_data(year = 2010,
                 age_group = 'age_18_50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, ages 18-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```


### 2012

```{r}
x <- join_data(year = 2012,
                 age_group = 'age_18_50')
plot_joined_data(x) +
    labs(title = 'Mortality rate by zone',
       subtitle = '2012, ages 18-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```


### 2014

```{r}
x <- join_data(year = 2014,
                 age_group = 'age_18_50')
plot_joined_data(x) +
    labs(title = 'Mortality rate by zone',
       subtitle = '2014, ages 18-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(x)
```

The below is a table of the same data.

```{r}
make_pretty(x)
```


## HIV rate among 18-50 year olds

In the below maps, HIV rate refers to the percentage of positives among all tested. It _only includes the AFEPI study_.

### 2010

```{r}
x <- join_data_hiv(year = 2010,
                 condition = 'Age >= 18 & Age <=50')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2010, ages 18-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

### 2012

```{r}
x <- join_data_hiv(year = 2012,
                 condition = 'Age >= 18 & Age <=50')
plot_joined_data(x,
                 fill_var = x@data$hiv_rate,
                 legend_title = 'HIV\nrate') +
  labs(title = 'HIV rate by zone',
       subtitle = '2012, ages 18-50')
```

The below is an interactive (zoomable and clickable) version of the same map.

```{r}
plot_joined_data_leaflet(joined_object = x,
                                     fill_var = x@data$hiv_rate,
                                     popup_text1 = 'HIV rate',
                                     popup_var1 = x@data$hiv_rate,
                                     popup_text2 = 'Number of positives',
                                     popup_var2 = x@data$positives,
                         legend_title = 'HIV rate')
```

The below is a table of the same data.

```{r}
make_pretty(x)
```

# Overlays


The below map shows the 2012 mortality rate at the zone level, with an overlay of all AFEPI participants (for whom geographic data were available), colored by test result.

```{r}
x <- join_data(year = 2012,
                 age_group = 'age_18_50')
plot_joined_data(x) +
  labs(title = 'Mortality rate by zone',
       subtitle = '2010, ages 18-50') +
  geom_point(data = afepi %>%
               filter(Resulttest != 'Indeterminado'),
             aes(x = lng,
                 y = lat,
                 group = NA,
                 color = Resulttest),
             alpha = 0.5,
             size = 0.5) +
  scale_color_manual(name = '',
                     values = c('darkgreen', 'darkred'))
```

The below map is identical, but interactive.

```{r}
x <- join_data(year = 2012,
                 age_group = 'age_18_50')
z <- afepi %>%
               filter(Resulttest != 'Indeterminado') %>%
                 mutate(color = ifelse(Resulttest == 'Positivo', 'darkgreen', 'darkred'))
popup <- paste0("<strong>Study ID: </strong>", 
                  z$StudyID, 
                  "<br><strong>",
                  'Age',
                  ": </strong>", 
                  z$Age,
                  "<br><strong>",
                  'Sex',
                  ": </strong>",
                  z$Sex)
plot_joined_data_leaflet(x) %>%
  addCircleMarkers(data = z,
               lng = ~lng,
               lat = ~lat,
               fillColor = ~color,
               color = NA,
               opacity = 0,
               radius = 3,
               popup = popup)
```

## Age distribution

### AFEPI participants

```{r}
cism_plot(x = afepi$Age) +
  labs(x = 'Years',
       title = 'Age distribution of AFEPI partipants')
```

### AFEPI participants by outcome

```{r}
ggplot(data = afepi %>%
         filter(Resulttest != 'Indeterminado'),
       aes(x = Age,
           group = Resulttest,
           fill = Resulttest)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(name = 'Test result',
                    values = c('darkorange', 'darkgreen')) +
  theme_cism() +
  labs(title = 'Age distribution of AFEPI participants',
       subtitle = 'By result status')
```

### Residents of study area

```{r}
ggplot(data = individual %>%
         mutate(age = as.numeric(Sys.Date() - as.Date(dob)) / 365.25) %>%
         filter(age <= 110),
       aes(x = age)) +
  geom_density(alpha = 0.6,
               fill = 'darkorange') +
  labs(x = 'Age',
       y = 'Density',
       title = 'Age distribution of Manhiça residents',
       subtitle = 'Per the census') +
  theme_cism()
```

## Sex distribution

### AFEPI participants

```{r}
cism_plot(afepi$Sex) +
  labs(title = 'Sex distribution of AFEPI participants')
```

### Residents of study area


```{r}
x <- individual$gender
x <- x[x %in% c('M', 'F')]
cism_plot(x) +
  labs(title = 'Sex distribution of study area')
```

# Packages used

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(packages, file = 'skeleton.bib')
```

```{r}
citation_text <- c()
  for (i in 1:length(packages)){
    citation_text[i] <- 
    paste0('[@R-',
               packages[i],
               ']')
}
```

```{r, results='asis'}
for (i in 1:length(citation_text)){
    cat('\n\n***\n\n~~\n\n')
  cat(citation_text[i])
  cat('\n\n***\n\n<br><br>')
}

```